============================================================
PROJECT SPECIFICATION: SECURE MULTI-TENANT DOCUMENT APPROVAL
============================================================
Focus: Laravel Security (Custom Guard, RBAC, Multi-tenancy)
Deadline: Today, < 24:00
------------------------------------------------------------

1. AUTHENTICATION & TOKEN MANAGEMENT
------------------------------------
1.1 Login Berhasil:
    - Input: email & password (valid), user (aktif), tenant (aktif).
    - Action: Generate random plaintext token, simpan hash(token) di DB,
      set expires_at, revoke token lama.
    - Output: Return plaintext token (one-time only).
1.2 Login Gagal:
    - Email tidak ada / Password salah: 401 Unauthorized.
    - User/Tenant nonaktif: 403 Forbidden.
1.3 Token Expired:
    - Reject request jika expires_at < now(). Response: 401.
1.4 Token Dicabut:
    - Reject jika revoked_at != null. Response: 401.

2. TENANT ISOLATION (CRITICAL)
------------------------------
2.1 Tenant Mismatch: Jika token tenant_id != resource tenant_id.
    Action: 403 Forbidden (Jangan bocorkan info keberadaan data).
2.2 Tenant Nonaktif: Jika tenant is_active = false, semua API reject (403).

3. DOCUMENT CREATION & EDITING
------------------------------
3.1 Buat Dokumen:
    - Role: Staff, Manager.
    - Rule: Status awal 'draft', hanya owner yang boleh edit.
    - Validation: Title wajib (422), Auditor dilarang buat (403).
3.2 Edit Dokumen:
    - Allow: Hanya jika status 'draft' dan user adalah creator.
    - Deny: Status != draft atau bukan owner.

4. SUBMIT DOCUMENT
------------------
4.1 Berhasil: Status 'draft' -> 'submitted', set submitted_at (hanya owner).
4.2 Gagal: Status != draft (422), Bukan owner (403).

5. APPROVAL PROCESS (STATE MACHINE)
-----------------------------------
5.1 Approve:
    - Role: Manager.
    - Rule: Status harus 'submitted', creator dilarang approve dokumen sendiri.
    - Action: Status -> 'approved', set approved_at, log ke document_approvals.
5.2 Reject:
    - Role: Manager. Rule: Wajib isi comment.
    - Action: Status -> 'rejected', set rejected_at.
5.3 Idempotency: Jika sudah approved/rejected, action ulang -> 409 Conflict.

6. VISIBILITY RULES
-------------------
- Admin/Manager: Lihat semua dokumen dalam tenant.
- Staff: Hanya lihat miliknya sendiri.
- Auditor: Hanya lihat dokumen status 'approved'.

7. AUDIT LOGGING (IMMUTABLE)
----------------------------
- Catat: Login, Logout, Create, Submit, Approve, Reject.
- Data: tenant_id, user_id, action, subject, old_data -> new_data, IP, User Agent.

8. SECURITY HARDENING
---------------------
- Error Strategy: Gunakan pesan generik (Forbidden) untuk cegah enumeration.
- Rate Limit: Login (5x/menit), Approval (10x/menit).
- Replay Attack Protection: Cek hash_token + User Agent mismatch.

9. BUSINESS INVARIANTS
----------------------
- Status tidak boleh lompat (e.g., Draft langsung Approved).
- Tidak ada akses cross-tenant.
- Approval tidak bisa di-undo.
- Logic bisnis harus di Service/Action classes, Controller tetap ramping.
============================================================
